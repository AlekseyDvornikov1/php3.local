<?xml version="1.0"?>
<project name="Phing Deploy Demo" basedir="." default="production">
    <target name="copy">
        <php returnProperty="build.date" function="date">
            <param value="Y-m-d-H-i-s"/>
        </php>
        <resolvepath propertyName="target.dir" path="C:\ser\OSPanel\domains\php3.local\${build.date}"/>
        <mkdir dir="${target.dir}"/>
        <property name="domain" value="test.com"/>
        <copy todir="${target.dir}">
            <fileset dir="${project.basedir}">
                <include name="**" />
            </fileset>
        </copy>


        <copy file="C:\ser\OSPanel\temp\php3.local\build\production\.env.example" tofile="${target.dir}\.env" overwrite="true">
            <filterchain>
                <replacetokens begintoken="{{" endtoken="}}">
                    <token key="db.name" value="${db.name}" />
                    <token key="db.username" value="${db.username}" />
                    <token key="db.password" value="${db.password}" />
                </replacetokens>
            </filterchain>
        </copy>

        <exec dir="${target.dir}" executable="mklink" passthru="true" checkreturn="true">
            <arg value="/j"/>
            <arg value="C:\ser\OSPanel\domains\php3.local\current"/>
            <arg value="${target.dir}"/>
        </exec>

    </target>

    <target name="composer">
        <exec dir="${target.dir}" executable="composer" passthru="true" checkreturn="true">
            <arg value="install"/>
        </exec>
    </target>

    <target name="migration">
        <exec dir="${target.dir}" executable="php" passthru="true" checkreturn="true">
            <arg value="artisan"/>
            <arg value="migrate"/>
            <arg value="--seed"/>
        </exec>
    </target>

    <target name="key">
        <exec dir="${target.dir}" executable="php" passthru="true" checkreturn="true">
            <arg value="artisan"/>
            <arg value="key:generate"/>
        </exec>
    </target>

    <target name="production" depends="copy, composer, migration, key">
        <echo msg="DONE!"/>
    </target>
</project>
